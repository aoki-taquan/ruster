# L2 Switching Test Topology
#
# Topology:
#   host1 --- [eth1] ruster [eth2] --- host2
#                      |
#                   [eth3]
#                      |
#                   host3
#
# All hosts are on the same L2 segment (10.0.1.0/24)
# ruster acts as L2 bridge/switch (no IP on bridge ports)

name: ruster-switching-test

topology:
  nodes:
    # Device Under Test - ruster in bridge mode
    ruster:
      kind: linux
      image: alpine:3.19
      binds:
        - ../../../target/release/ruster:/usr/local/bin/ruster:ro
        - ./config.toml:/etc/ruster/config.toml:ro
      exec:
        # Create a bridge and add interfaces
        - ip link add br0 type bridge
        - ip link set eth1 master br0
        - ip link set eth2 master br0
        - ip link set eth3 master br0
        - ip link set br0 up
        - ip link set eth1 up
        - ip link set eth2 up
        - ip link set eth3 up

    # Host 1
    host1:
      kind: linux
      image: alpine:3.19
      exec:
        - ip addr add 10.0.1.1/24 dev eth1

    # Host 2
    host2:
      kind: linux
      image: alpine:3.19
      exec:
        - ip addr add 10.0.1.2/24 dev eth1

    # Host 3
    host3:
      kind: linux
      image: alpine:3.19
      exec:
        - ip addr add 10.0.1.3/24 dev eth1

  links:
    - endpoints: ["ruster:eth1", "host1:eth1"]
    - endpoints: ["ruster:eth2", "host2:eth1"]
    - endpoints: ["ruster:eth3", "host3:eth1"]
