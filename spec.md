# Ruster - Software Router Specification

## 1. Overview

Rustで実装するソフトウェアルータ。ネットワーク学習を目的とし、L2以上のプロトコルをフルスクラッチで実装する。

### 1.1 Goals

- ネットワークプロトコルの学習・理解
- 10Gbps性能目標（一般家庭向けに普及している帯域）
- 設定の透明性（lockファイルによる完全な設定可視化）
- Rustの型安全性・所有権を活かしたメモリ安全な実装

### 1.2 Design Principles

- **L1はLinuxに委任**: ハードウェア固有の設定はLinuxの機能を活用
- **L2以上は自前実装**: スイッチング・ルーティングをユーザースペースで処理
- **外部ライブラリ非依存**: ネットワーク処理部分は独自実装（学習目的）
- **複数I/Oバックエンド**: DPDK, AF_PACKET, AF_XDPを選択可能

---

## 2. Development Phases

### Phase 1: 家庭用ルータ相当

一般家庭で使用されるルータに求められる全機能。

#### L2プロトコル
- [ ] Ethernet (IEEE 802.3)
- [ ] VLAN (IEEE 802.1Q)
- [ ] ARP (RFC 826)
- [ ] NDP (RFC 4861) - IPv6近隣探索

#### L3プロトコル
- [ ] IPv4 (RFC 791)
- [ ] IPv6 (RFC 8200)
- [ ] ICMP (RFC 792)
- [ ] ICMPv6 (RFC 4443)

#### ルーティング
- [ ] 静的ルーティング
- [ ] ポリシーベースルーティング

#### NAT/ファイアウォール
- [ ] NAPT (RFC 3022) - IPマスカレード
- [ ] Stateful Packet Inspection
- [ ] 基本的なパケットフィルタリング

#### サービス
- [ ] DHCPv4サーバー (RFC 2131)
- [ ] DHCPv4クライアント
- [ ] DHCPv6クライアント (RFC 8415)
- [ ] DNS フォワーダー

#### その他
- [ ] PPPoE クライアント (RFC 2516)
- [ ] MAC学習・FDB (L2スイッチング)

---

### Phase 2: 社内ネットワーク向け

企業内ネットワークで使用される機能。

#### 動的ルーティング
- [ ] OSPF (RFC 2328) - エリア内ルーティング
- [ ] OSPFv3 (RFC 5340) - IPv6対応
- [ ] BGP-4 (RFC 4271) - 基本的なeBGP/iBGP

#### 冗長化
- [ ] VRRP (RFC 5798)
- [ ] BFD (RFC 5880) - 障害検知

#### セキュリティ
- [ ] 802.1X認証
- [ ] RADIUS クライアント
- [ ] ACL (拡張アクセスリスト)

#### QoS
- [ ] DiffServ (RFC 2474)
- [ ] トラフィックシェーピング

#### L2拡張
- [ ] STP/RSTP (IEEE 802.1D/802.1w)
- [ ] LACP (IEEE 802.3ad)

---

### Phase 3: DC向け

データセンター規模のネットワーク機能。

#### オーバーレイ
- [ ] VXLAN (RFC 7348)
- [ ] EVPN (RFC 7432)

#### BGP拡張
- [ ] BGP Route Reflector
- [ ] BGP Confederations
- [ ] BGP Flowspec (RFC 5575)

#### 高度なルーティング
- [ ] IS-IS (RFC 1195)
- [ ] Segment Routing (RFC 8402)
- [ ] MPLS (RFC 3031)

#### マルチキャスト
- [ ] IGMP (RFC 3376)
- [ ] PIM-SM (RFC 7761)

---

## 3. Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      Control Plane                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────┐  │
│  │  Config  │  │ Routing  │  │   ARP    │  │   DHCP     │  │
│  │  Manager │  │  Table   │  │  Table   │  │  Server    │  │
│  └──────────┘  └──────────┘  └──────────┘  └────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Data Plane                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────┐  │
│  │  Ingress │→ │  Parse   │→ │ Process  │→ │  Egress    │  │
│  │          │  │  Frame   │  │ Pipeline │  │            │  │
│  └──────────┘  └──────────┘  └──────────┘  └────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     I/O Backend (選択可能)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  AF_PACKET  │  │   AF_XDP    │  │       DPDK          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   Linux Kernel  │
                    │      (L1)       │
                    └─────────────────┘
```

---

## 4. Configuration System

### 4.1 設計思想

- 設定間の依存関係を明確化
- 非明示的な設定を防止
- lockファイルによる完全な設定の可視化

### 4.2 ファイル構成

```
/etc/ruster/
├── config.toml      # ユーザーが記述する明示的設定
└── config.lock      # 生成される完全な設定（全ての暗黙値を含む）
```

### 4.3 config.toml (例)

```toml
[interfaces.eth0]
role = "wan"
addressing = "dhcp"

[interfaces.eth1]
role = "lan"
address = "192.168.1.1/24"

[dhcp.lan]
range = ["192.168.1.100", "192.168.1.200"]
gateway = "192.168.1.1"
dns = ["8.8.8.8", "8.8.4.4"]

[nat]
enabled = true
wan = "eth0"
lan = ["eth1"]
```

### 4.4 config.lock (生成例)

```toml
# Generated by ruster - DO NOT EDIT
# Generated at: 2025-01-03T12:00:00Z
# Source: config.toml (sha256: abc123...)

[interfaces.eth0]
role = "wan"
addressing = "dhcp"
mtu = 1500                    # 暗黙のデフォルト
mac = "auto"                  # 暗黙のデフォルト
duplex = "auto"               # 暗黙のデフォルト

[interfaces.eth1]
role = "lan"
address = "192.168.1.1/24"
mtu = 1500
mac = "auto"
duplex = "auto"

[dhcp.lan]
interface = "eth1"            # roleから推論
range = ["192.168.1.100", "192.168.1.200"]
gateway = "192.168.1.1"
dns = ["8.8.8.8", "8.8.4.4"]
lease_time = 86400            # 暗黙のデフォルト (24時間)
domain = ""                   # 暗黙のデフォルト

[nat]
enabled = true
wan = "eth0"
lan = ["eth1"]
type = "napt"                 # 暗黙のデフォルト

[routing]
# 暗黙的に生成されるルート
[[routing.static]]
destination = "0.0.0.0/0"
gateway = "dhcp"              # eth0から取得
interface = "eth0"
source = "auto"               # DHCPから自動設定

[[routing.static]]
destination = "192.168.1.0/24"
gateway = "direct"
interface = "eth1"
source = "config"             # config.tomlのeth1設定から
```

### 4.5 Lockファイル生成時の検証

```
$ ruster config generate

[INFO] Loading config.toml...
[WARN] interfaces.eth0: mtu not specified, using default 1500
[WARN] dhcp.lan: lease_time not specified, using default 86400
[INFO] Validating dependencies...
[INFO] NAT requires routing from lan to wan: OK
[INFO] DHCP range within interface subnet: OK
[ERROR] interfaces.eth2: referenced in nat.lan but not defined
```

---

## 5. I/O Backend

### 5.1 AF_PACKET

最もポータブルな選択肢。特別な設定不要。

```rust
trait Capture: Send + Sync {
    async fn recv(&mut self, buf: &mut [u8]) -> io::Result<RxInfo>;
    async fn send(&mut self, buf: &[u8]) -> io::Result<usize>;
}
```

### 5.2 AF_XDP

高性能なLinuxネイティブ方式。カーネル4.18以降。

### 5.3 DPDK

最高性能。専用のドライバ設定が必要。

---

## 6. Performance Target

| 指標 | 目標値 |
|------|--------|
| スループット | 10 Gbps (line rate) |
| レイテンシ | < 100 μs (p99) |
| パケット処理 | > 14.88 Mpps (64byte frames @ 10G) |

---

## 7. Testing Strategy

### 7.1 Unit Tests

- フレームパース・シリアライズ
- プロトコル処理ロジック
- ルーティングテーブル操作
- 設定パース・バリデーション

### 7.2 Integration Tests (Containerlab)

```yaml
# topology.yml
name: ruster-test
topology:
  nodes:
    ruster:
      kind: linux
      image: ruster:latest
    client:
      kind: linux
    server:
      kind: linux
  links:
    - endpoints: ["ruster:eth1", "client:eth1"]
    - endpoints: ["ruster:eth2", "server:eth1"]
```

### 7.3 Performance Tests

- iperf3によるスループット測定
- pktgenによるパケットレート測定
- レイテンシ分布測定

---

## 8. Dependencies

```toml
[dependencies]
tokio = { version = "1", features = ["rt-multi-thread", "macros", "net", "io-util"] }
libc = "0.2"
toml = "0.8"
serde = { version = "1", features = ["derive"] }
thiserror = "2"
tracing = "0.1"

# Optional: high-performance backends
# dpdk-rs = { version = "...", optional = true }
# af-xdp = { version = "...", optional = true }
```

---

## 9. Non-Goals

- GUI管理画面
- SNMP (Phase 2以降で検討)
- NetFlow/sFlow (Phase 3で検討)
- ハードウェアオフロード
