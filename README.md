# Ruster

Rustで実装するソフトウェアルータ。ネットワーク学習を目的としたプロジェクト。

## クイックリファレンス

```bash
# ビルド
cargo build

# テスト（ユニットテスト）
cargo test

# フォーマット・リント
cargo fmt
cargo clippy

# E2Eテスト（Docker/Containerlab必要）
cargo test --test e2e --features e2e
```

## 特徴

- **フルスクラッチ実装**: ネットワーク処理部分（パケット解析、ルーティング）は外部ライブラリに依存せず独自実装
- **ユーザースペース処理**: L2以上のスイッチング・ルーティングをユーザースペースで処理
- **設定の透明性**: lockファイルによる完全な設定可視化
- **10Gbps性能目標**: 一般家庭向けに普及している帯域を目標

## 実装済み機能

### プロトコル

| レイヤ | プロトコル |
|--------|------------|
| L2 | Ethernet, ARP, PPPoE, PPP, LCP, PAP, CHAP, IPCP |
| L3 | IPv4, IPv6, ICMP, ICMPv6 |
| L4 | TCP, UDP |
| サービス | DHCP, DHCPv6, DNS |

### データプレーン

- **ルーティング**: 静的ルーティング、ポリシーベースルーティング(PBR)
- **NAT/ファイアウォール**: NAPT、コネクショントラッキング、パケットフィルタリング
- **ARP/NDP処理**: ARPテーブル、近隣キャッシュ、NDP処理
- **サービス**: DHCPクライアント/サーバー、DHCPv6クライアント、DNSフォワーダー
- **その他**: PPPoEクライアント、RA(Router Advertisement)クライアント/サーバー、FDB(MAC学習)

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      Control Plane                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────┐  │
│  │  Config  │  │ Routing  │  │   ARP    │  │   DHCP     │  │
│  │  Manager │  │  Table   │  │  Table   │  │  Server    │  │
│  └──────────┘  └──────────┘  └──────────┘  └────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Data Plane                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────┐  │
│  │  Ingress │→ │  Parse   │→ │ Process  │→ │  Egress    │  │
│  │          │  │  Frame   │  │ Pipeline │  │            │  │
│  └──────────┘  └──────────┘  └──────────┘  └────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     I/O Backend (選択可能)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  AF_PACKET  │  │   AF_XDP    │  │       DPDK          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   Linux Kernel  │
                    │      (L1)       │
                    └─────────────────┘
```

## プロジェクト構造

```
src/
├── capture/      # パケットキャプチャ (AF_PACKET)
├── config/       # 設定ファイルパース・バリデーション
├── dataplane/    # データプレーン処理
│   ├── router.rs         # メインルータ処理
│   ├── routing.rs        # ルーティングテーブル
│   ├── forwarder.rs      # パケット転送
│   ├── napt.rs           # NAPT処理
│   ├── firewall.rs       # ファイアウォール
│   ├── conntrack.rs      # コネクショントラッキング
│   ├── arp_processor.rs  # ARP処理
│   ├── ndp_processor.rs  # NDP処理
│   ├── dhcp_client.rs    # DHCPクライアント
│   ├── dhcp_server.rs    # DHCPサーバー
│   ├── dns_forwarder.rs  # DNSフォワーダー
│   ├── pppoe_client.rs   # PPPoEクライアント
│   └── ...
├── protocol/     # プロトコル実装
│   ├── ethernet.rs  # Ethernetフレーム
│   ├── ipv4.rs      # IPv4パケット
│   ├── ipv6.rs      # IPv6パケット
│   ├── arp.rs       # ARP
│   ├── icmp.rs      # ICMP
│   ├── tcp.rs       # TCP
│   ├── udp.rs       # UDP
│   ├── dhcp.rs      # DHCP
│   ├── pppoe.rs     # PPPoE
│   └── ...
├── telemetry/    # ログ・メトリクス
├── error.rs      # エラー型定義
├── lib.rs        # ライブラリエントリポイント
└── main.rs       # バイナリエントリポイント
```

## 設計原則

1. **L1はLinuxに委任**: ハードウェア固有の設定はLinuxの機能を活用
2. **L2以上は自前実装**: スイッチング・ルーティングをユーザースペースで処理
3. **外部ライブラリ非依存**: ネットワーク処理部分（パケット解析、ルーティング）は独自実装
4. **設定の透明性**: lockファイルによる完全な設定可視化

## テスト

### ユニットテスト

プロトコルパース、ルーティングテーブル操作等の単体テスト。

```bash
cargo test
```

### E2Eテスト

Containerlabを使用した統合テスト。Dockerが必要。

```bash
cargo test --test e2e --features e2e
```

テストは `tests/e2e/` 以下に配置。

## 注意事項

- ruster実行時はAF_PACKET使用のためroot権限が必要
- E2EテストにはDocker/Containerlabのインストールが必要

## ライセンス

MIT
